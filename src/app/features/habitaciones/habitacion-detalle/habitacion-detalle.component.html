<div class="container py-4">
  <!-- Loading -->
  @if (loading) {
  <app-loading message="Cargando habitación..." [fullscreen]="true"></app-loading>
  }

  <!-- Error -->
  @if (error) {
  <app-error title="Habitación no encontrada"
    message="No se encontró la habitación solicitada o hubo un error al cargar los datos.">
  </app-error>
  }

  <!-- Contenido -->
  @if (!loading && !error && habitacion) {
  <div class="row g-4">
    <!-- Galería de imágenes -->
    <div class="col-lg-7">
      <div class="position-relative">
        <img [src]="imagenes[imagenActual]" class="img-fluid rounded-4 shadow main-image"
          [alt]="habitacion.NombreHabitacion"
          (error)="imagenes[imagenActual] = 'https://imageness3realdecuenca.s3.us-east-2.amazonaws.com/Imagen4.png'">

        @if (imagenes.length > 1) {
        <button class="btn btn-light position-absolute top-50 start-0 translate-middle-y ms-2 rounded-circle"
          (click)="cambiarImagen(-1)">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="btn btn-light position-absolute top-50 end-0 translate-middle-y me-2 rounded-circle"
          (click)="cambiarImagen(1)">
          <i class="bi bi-chevron-right"></i>
        </button>
        }
      </div>

      <!-- Miniaturas -->
      @if (imagenes.length > 1) {
      <div class="d-flex gap-2 mt-3 overflow-auto pb-2">
        @for (img of imagenes; track $index) {
        <img [src]="img" class="thumbnail" [class.active]="imagenActual === $index" [alt]="'Imagen ' + ($index + 1)"
          (click)="seleccionarImagen($index)"
          (error)="imagenes[$index] = 'https://imageness3realdecuenca.s3.us-east-2.amazonaws.com/Imagen4.png'">
        }
      </div>
      }
    </div>

    <!-- Información y formulario -->
    <div class="col-lg-5">
      <div class="card shadow-sm rounded-4">
        <div class="card-body p-4">
          <h2 class="fw-bold text-hotel mb-2">{{ habitacion.NombreHabitacion }}</h2>

          <p class="text-muted mb-3">
            <i class="bi bi-building me-1"></i> {{ habitacion.NombreHotel || 'Hotel' }}
            <span class="mx-2">•</span>
            <i class="bi bi-geo-alt me-1"></i> {{ habitacion.NombreCiudad }}, {{ habitacion.NombrePais }}
          </p>

          <div class="d-flex align-items-center mb-4">
            <span class="fs-3 fw-bold text-hotel">${{ habitacion.PrecioActualHabitacion | number:'1.0-2' }}</span>
            <span class="text-muted ms-2">/ noche</span>
            @if (habitacion.PrecioNormalHabitacion && habitacion.PrecioNormalHabitacion >
            habitacion.PrecioActualHabitacion) {
            <span class="text-decoration-line-through text-muted ms-2 small">
              ${{ habitacion.PrecioNormalHabitacion | number:'1.0-2' }}
            </span>
            }
          </div>

          <!-- Info rápida -->
          <div class="row g-3 mb-4">
            <div class="col-6">
              <div class="info-box">
                <i class="bi bi-people fs-4 text-hotel"></i>
                <div>
                  <span class="small text-muted d-block">Capacidad</span>
                  <strong>{{ habitacion.CapacidadHabitacion }} persona(s)</strong>
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="info-box">
                <i class="bi bi-tag fs-4 text-hotel"></i>
                <div>
                  <span class="small text-muted d-block">Tipo</span>
                  <strong>{{ habitacion.NombreTipoHabitacion || 'Estándar' }}</strong>
                </div>
              </div>
            </div>
          </div>

          <!-- Amenidades -->
          @if (amenidades.length > 0) {
          <div class="mb-4">
            <h6 class="fw-bold mb-2">
              <i class="bi bi-check-circle text-success me-1"></i> Amenidades
            </h6>
            <div class="d-flex flex-wrap gap-2">
              @for (amenidad of amenidades; track amenidad) {
              <span class="badge bg-light text-dark border">{{ amenidad }}</span>
              }
            </div>
          </div>
          }

          <hr>

          <!-- Formulario de reserva -->
          <h5 class="fw-bold mb-3">
            <i class="bi bi-calendar-check me-1"></i> Reservar
          </h5>

          @if (errorMessage) {
          <div class="alert alert-danger p-2 small">{{ errorMessage }}</div>
          }

          <form [formGroup]="reservaForm" (ngSubmit)="onSubmit()">
            <!-- Litepicker Range Picker -->
            <div class="mb-3">
              <label class="form-label small fw-bold">Rango de fechas</label>
              <input type="text" id="rango-fechas" class="form-control"
                placeholder="Selecciona fechas de entrada y salida" readonly
                [class.is-invalid]="(f['fechaInicio'].touched || f['fechaFin'].touched) && (f['fechaInicio'].invalid || f['fechaFin'].invalid)">

              <!-- Hidden inputs to sync with reactive form -->
              <input type="hidden" formControlName="fechaInicio">
              <input type="hidden" formControlName="fechaFin">

              @if ((f['fechaInicio'].touched || f['fechaFin'].touched) && f['fechaInicio'].invalid) {
              <div class="text-danger small mt-1">Debes seleccionar la fecha de entrada.</div>
              }
              @if ((f['fechaFin'].touched) && f['fechaFin'].invalid) {
              <div class="text-danger small mt-1">Debes seleccionar la fecha de salida.</div>
              }
            </div>

            <!-- Leyenda de fechas -->
            <div class="d-flex gap-3 mb-3 small">
              <div class="d-flex align-items-center">
                <span class="badge bg-danger me-1" style="width: 12px; height: 12px;"></span>
                <span class="text-muted">Ocupadas</span>
              </div>
              <div class="d-flex align-items-center">
                <span class="badge bg-primary me-1" style="width: 12px; height: 12px;"></span>
                <span class="text-muted">Seleccionadas</span>
              </div>
            </div>

            @if (reservaForm.errors?.['fechasInvalidas'] && f['fechaFin'].touched) {
            <div class="text-danger small mt-1">
              La fecha de salida debe ser posterior a la fecha de entrada.
            </div>
            }

            <div class="mt-3">
              <label class="form-label small">Número de huéspedes</label>
              <select class="form-select" formControlName="numeroHuespedes"
                [class.is-invalid]="f['numeroHuespedes'].touched && f['numeroHuespedes'].invalid">
                @for (n of [].constructor(habitacion.CapacidadHabitacion); track $index) {
                <option [value]="$index + 1">{{ $index + 1 }} {{ $index === 0 ? 'persona' : 'personas' }}</option>
                }
              </select>
              @if (f['numeroHuespedes'].touched && f['numeroHuespedes'].errors) {
              <div class="invalid-feedback">
                @if (f['numeroHuespedes'].errors['min']) {
                Debe haber al menos 1 huésped.
                } @else if (f['numeroHuespedes'].errors['max']) {
                Máximo {{ habitacion.CapacidadHabitacion }} huéspedes.
                }
              </div>
              }
            </div>

            <div class="d-grid mt-4">
              @if (isLoggedIn) {
              <button type="submit" class="btn btn-hotel btn-lg" [disabled]="submitting">
                @if (submitting) {
                <span class="spinner-border spinner-border-sm me-1"></span>
                Procesando...
                } @else {
                <i class="bi bi-calendar-plus me-1"></i> Reservar Ahora
                }
              </button>
              } @else {
              <a routerLink="/login" [queryParams]="{returnUrl: '/habitaciones/' + habitacion.IdHabitacion}"
                class="btn btn-hotel btn-lg">
                <i class="bi bi-box-arrow-in-right me-1"></i> Inicia sesión para reservar
              </a>
              }
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón volver -->
  <div class="mt-4">
    <a routerLink="/habitaciones" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i> Volver a habitaciones
    </a>
  </div>
  }
</div>

<!-- Modal de Confirmación -->
@if (showConfirmModal && preReservaData) {
<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-hotel text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle me-2"></i>Confirmar Reserva
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
      </div>
      <div class="modal-body p-4">
        @if (modalError) {
        <div class="alert alert-danger mb-3">
          {{ modalError }}
        </div>
        }

        <div class="alert alert-info d-flex align-items-center mb-4">
          <i class="bi bi-clock-history fs-3 me-3"></i>
          <div>
            <strong>Tiempo restante para confirmar:</strong>
            <div class="fs-4 fw-bold">{{ formatTime(preReservaData.tiempoRestante) }}</div>
          </div>
        </div>

        <h6 class="fw-bold mb-3 border-bottom pb-2">Detalles de la Reserva</h6>

        <div class="row g-3 mb-4">
          <div class="col-6">
            <small class="text-muted d-block">Habitación</small>
            <strong>{{ habitacion?.NombreHabitacion }}</strong>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Huéspedes</small>
            <strong>{{ preReservaData.numeroHuespedes }}</strong>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Entrada</small>
            <strong>{{ formatDate(preReservaData.fechaInicio) }}</strong>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Salida</small>
            <strong>{{ formatDate(preReservaData.fechaFin) }}</strong>
          </div>
          <div class="col-12 mt-3">
            <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
              <span class="fw-bold">Total Estimado:</span>
              <span class="fs-5 fw-bold text-hotel">${{ preReservaData.precioEstimado | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>

        <div class="d-grid gap-2">
          <button type="button" class="btn btn-hotel btn-lg" (click)="confirmarReserva()"
            [disabled]="confirmando || cancelando">
            @if (confirmando) {
            <span class="spinner-border spinner-border-sm me-2"></span>Procesando...
            } @else {
            Continuar
            }
          </button>
          <button type="button" class="btn btn-outline-danger" (click)="cancelarPreReserva()"
            [disabled]="confirmando || cancelando">
            @if (cancelando) {
            <span class="spinner-border spinner-border-sm me-2"></span>Cancelando...
            } @else {
            Cancelar
            }
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
}